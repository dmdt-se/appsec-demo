@page
@model AppSecDotnetDemo.Pages.ExecuteModel
@{
    ViewData["Title"] = "Execute Assembly";
}

<h1>Execute Assembly Method</h1>

<div class="row">
    <div class="col-md-6">
        <form method="post">
            <div class="mb-3">
                <label for="SelectedAssemblyId" class="form-label">Select Assembly</label>
                <select class="form-select" id="SelectedAssemblyId" name="SelectedAssemblyId" required>
                    <option value="">-- Select an assembly --</option>
                    @foreach (var option in Model.AssemblyOptions)
                    {
                        <option value="@option.Value">@option.Text</option>
                    }
                </select>
            </div>
            <div class="mb-3">
                <label for="TypeName" class="form-label">Type Name (fully qualified)</label>
                <input type="text" class="form-control" id="TypeName" name="TypeName"
                       value="@Model.TypeName" placeholder="e.g., LegitimatePlugin.DataProcessor" required>
            </div>
            <div class="mb-3">
                <label for="MethodName" class="form-label">Method Name</label>
                <input type="text" class="form-control" id="MethodName" name="MethodName"
                       value="@Model.MethodName" placeholder="e.g., Process" required>
            </div>
            <div class="mb-3">
                <label for="MethodParameter" class="form-label">Parameter (optional)</label>
                <input type="text" class="form-control" id="MethodParameter" name="MethodParameter"
                       value="@Model.MethodParameter" placeholder="e.g., ' OR '1'='1' --">
                <div class="form-text">Leave empty for methods without parameters</div>
            </div>
            <button type="submit" class="btn btn-danger">Execute</button>
            <a asp-page="/Index" class="btn btn-secondary">Back to Home</a>
        </form>
    </div>
</div>

@if (Model.Result != null)
{
    <div class="row mt-4">
        <div class="col-md-8">
            <h3>Execution Result</h3>
            <div class="card">
                <div class="card-header @(Model.Result.Success ? "bg-success text-white" : "bg-danger text-white")">
                    @(Model.Result.Success ? "Success" : "Error")
                    <span class="float-end">Execution time: @Model.Result.ExecutionTime.TotalMilliseconds.ToString("F2") ms</span>
                </div>
                <div class="card-body">
                    @if (Model.Result.Success)
                    {
                        <pre class="mb-0">@Model.Result.Output</pre>
                    }
                    else
                    {
                        <pre class="text-danger mb-0">@Model.Result.Error</pre>
                    }
                </div>
            </div>
        </div>
    </div>
}

<div class="row mt-4" data-attack-catalog>
    <div class="col-md-8">
        <div class="card border-warning">
            <div class="card-header bg-warning">Attack Catalog (from portal)</div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Attack type</label>
                    <select class="form-select" data-attack-type></select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Variant</label>
                    <select class="form-select" data-attack-variant></select>
                </div>
                <span class="badge bg-secondary mb-2" data-attack-compatibility></span>
                <div class="text-muted mb-2" data-attack-description></div>
                <code class="d-block mb-3" data-attack-payload></code>
                <button type="button" class="btn btn-outline-primary" data-attack-fill>Fill form</button>
                <small class="text-muted d-block mt-2">Select a variant to auto-fill the execute form above.</small>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card border-info">
            <div class="card-header bg-info text-white">Quick Reference</div>
            <div class="card-body">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Plugin</th>
                            <th>Type.Method</th>
                            <th>Parameter</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- LegitimatePlugin -->
                        <tr class="table-success">
                            <td><strong>LegitimatePlugin</strong><br><small class="text-muted">Baseline</small></td>
                            <td><code>LegitimatePlugin.DataProcessor.Process</code></td>
                            <td><small class="text-muted">(none)</small></td>
                            <td>
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="fillForm('LegitimatePlugin.DataProcessor', 'Process', '')">Fill Form</button>
                            </td>
                        </tr>

                        <!-- HardcodedAttackPlugin -->
                        <tr class="table-warning">
                            <td><strong>HardcodedAttackPlugin</strong><br><small class="text-muted">Hardcoded Attack</small></td>
                            <td><code>HardcodedAttackPlugin.Backdoor.Run</code></td>
                            <td><small class="text-muted">(none)</small></td>
                            <td>
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="fillForm('HardcodedAttackPlugin.Backdoor', 'Run', '')">Fill Form</button>
                            </td>
                        </tr>

                        <!-- TaintedInputPlugin -->
                        <tr class="table-primary">
                            <td rowspan="3"><strong>TaintedInputPlugin</strong><br><small class="text-muted">RAP Detection</small></td>
                            <td><code>TaintedInputPlugin.Attacks.InitializeDatabase</code><br><small class="text-muted">Setup database first</small></td>
                            <td><small class="text-muted">(none)</small></td>
                            <td>
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="fillForm('TaintedInputPlugin.Attacks', 'InitializeDatabase', '')">Fill Form</button>
                            </td>
                        </tr>
                        <tr>
                            <td><code>TaintedInputPlugin.Attacks.SearchUsers</code><br><small class="text-muted">SQL Injection</small></td>
                            <td>
                                <small><strong>Safe:</strong> Alice</small><br>
                                <small><strong>Attack:</strong> ' OR '1'='1' --</small>
                            </td>
                            <td>
                                <button type="button" class="btn btn-sm btn-success" onclick="fillForm('TaintedInputPlugin.Attacks', 'SearchUsers', 'Alice')">Safe</button>
                                <button type="button" class="btn btn-sm btn-danger" onclick="fillForm('TaintedInputPlugin.Attacks', 'SearchUsers', '\' OR \'1\'=\'1\' --')">Attack</button>
                            </td>
                        </tr>
                        <tr>
                            <td><code>TaintedInputPlugin.Attacks.ExecuteCommand</code><br><small class="text-muted">Command Injection</small></td>
                            <td>
                                <small><strong>Safe:</strong> echo hello</small><br>
                                <small><strong>Attack:</strong> cat /etc/passwd</small>
                            </td>
                            <td>
                                <button type="button" class="btn btn-sm btn-success" onclick="fillForm('TaintedInputPlugin.Attacks', 'ExecuteCommand', 'echo hello')">Safe</button>
                                <button type="button" class="btn btn-sm btn-danger" onclick="fillForm('TaintedInputPlugin.Attacks', 'ExecuteCommand', 'cat /etc/passwd')">Attack</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
function fillForm(typeName, methodName, parameter) {
    document.getElementById('TypeName').value = typeName;
    document.getElementById('MethodName').value = methodName;
    document.getElementById('MethodParameter').value = parameter || '';
}
</script>
